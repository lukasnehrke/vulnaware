package dev.lukasnehrke.vulnaware.vulnerability.service;

import dev.lukasnehrke.vulnaware.bom.repository.BomRepository;
import dev.lukasnehrke.vulnaware.vulnerability.service.VulnerabilityService;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.hibernate.Hibernate;
import org.springframework.context.annotation.Profile;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class MonitoringService {

    private final BomRepository boms;
    private final VulnerabilityService vulnService;

    @Transactional
    public void analyzeMonitored() {
        final var sort = Sort.by(Sort.Direction.ASC, "lastAnalyzedAt");
        final var list = boms.findAllByMonitoring(true, PageRequest.of(0, 100, sort));

        for (final var bom : list) {
            Hibernate.initialize(bom.getComponents());
            Hibernate.initialize(bom.getVulnerabilities());
            vulnService.analyze(bom);
        }
    }
}
